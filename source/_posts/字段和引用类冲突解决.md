---
title: Jackson JsonAnyGetter 字段和引用类冲突解
date: 2025-04-30 21:06:09
tags:
  - java
---

## 方法一 重写AnyWriter

```java
import cn.hutool.core.util.ReflectUtil;
import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.databind.BeanProperty;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.SerializerProvider;
import com.fasterxml.jackson.databind.introspect.AnnotatedMember;
import com.fasterxml.jackson.databind.ser.AnyGetterWriter;

import java.lang.reflect.Field;
import java.util.Arrays;
import java.util.Map;

public class CustomAnyGetterWriter extends AnyGetterWriter {
	public CustomAnyGetterWriter(BeanProperty property, AnnotatedMember accessor, JsonSerializer<?> serializer) {
		super(property, accessor, serializer);
	}

	public void getAndSerialize(Object bean, JsonGenerator gen, SerializerProvider provider)
		throws Exception {
		Object value = _accessor.getValue(bean);
		if (value == null) {
			return;
		}
		if (!(value instanceof Map<?, ?>)) {
			provider.reportBadDefinition(_property.getType(), String.format(
				"Value returned by 'any-getter' %s() not java.util.Map but %s",
				_accessor.getName(), value.getClass().getName()));
		}

		// 23-Feb-2015, tatu: Nasty, but has to do (for now)
		if (_mapSerializer != null) {
			Map<?, ?> mapValue = (Map<?, ?>) value;


			Arrays.stream(ReflectUtil.getFields(_accessor.getDeclaringClass()))
				.map(Field::getName)
				.filter(name -> !name.equals(_property.getName()))
				.forEach(mapValue::remove);
			_mapSerializer.serializeWithoutTypeInfo(mapValue, gen, provider);
			return;
		}
		_serializer.serialize(value, gen, provider);
	}


}
 
```


使用自定义BeanSerializerModifier来处理

```java
import cn.hutool.core.util.ReflectUtil;
import com.fasterxml.jackson.databind.BeanDescription;
import com.fasterxml.jackson.databind.BeanProperty;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.SerializationConfig;
import com.fasterxml.jackson.databind.introspect.AnnotatedMember;
import com.fasterxml.jackson.databind.ser.BeanSerializerBuilder;
import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;

public class DuplicateFieldSerializerModifier extends BeanSerializerModifier {


	@Override
	public BeanSerializerBuilder updateBuilder(SerializationConfig config, BeanDescription beanDesc, BeanSerializerBuilder builder) {
		BeanProperty property = (BeanProperty) ReflectUtil.getFieldValue(builder.getAnyGetter(), "_property");
		AnnotatedMember accessor = (AnnotatedMember) ReflectUtil.getFieldValue(builder.getAnyGetter(), "_accessor");
		JsonSerializer<Object> serializer = (JsonSerializer<Object>) ReflectUtil.getFieldValue(builder.getAnyGetter(), "_serializer");
		builder.setAnyGetter(new CustomAnyGetterWriter(property, accessor, serializer));
		return super.updateBuilder(config, beanDesc, builder);
	}
}


```

进行注册

```java
ObjectMapper objectMapper = new ObjectMapper();

objectMapper.registerModule(new SimpleModule(){
        @Override
        public void setupModule(SetupContext context) {
            context.addBeanSerializerModifier(new DuplicateFieldSerializerModifier());
        }
    });

```

## 方法二